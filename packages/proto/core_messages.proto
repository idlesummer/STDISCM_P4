// Core Messages Protocol - ML Training Monitoring
//
// This file contains the complete protocol for ML training monitoring:
// - Service definitions (RPC procedures)
// - Core data messages (message types)
//
// Purpose: Enable real-time communication between training backend and dashboard

syntax = "proto3";

package metrics;

// ============================================================================
// SERVICE DEFINITIONS (RPC Procedures)
// ============================================================================

service MetricsService {
  // Bidirectional streaming RPC for continuous metrics exchange
  // Client sends: BatchData, EpochData
  // Server sends: Acknowledgments
  rpc StreamMetrics(stream MetricsRequest) returns (stream MetricsResponse);

  // Unary RPC for initial session registration
  rpc RegisterSession(SessionInfo) returns (SessionResponse);
}

// ============================================================================
// REQUEST/RESPONSE WRAPPERS
// ============================================================================

// Client request wrapper
message MetricsRequest {
  string session_id = 1;
  uint64 timestamp_ms = 2;

  oneof payload {
    BatchData batch_data = 3;
    EpochData epoch_data = 4;
  }
}

// Server response wrapper
message MetricsResponse {
  string session_id = 1;
  uint64 timestamp_ms = 2;
  bool success = 3;
  string message = 4;
}

// Session registration request
message SessionInfo {
  string session_id = 1;
  string client_name = 2;
  uint64 timestamp_ms = 3;
}

// Session registration response
message SessionResponse {
  bool success = 1;
  string session_id = 2;
  string message = 3;
}

// ============================================================================
// CORE DATA MESSAGES (4 Message Types)
// ============================================================================

// 1. Per-batch metrics data (HIGH FREQUENCY ~60 FPS)
message BatchData {
  uint32 epoch = 1;
  uint32 batch_idx = 2;
  repeated ImageData images = 3;           // Up to 16 images
  repeated Prediction predictions = 4;
  repeated int32 ground_truth = 5;         // Class indices
  float batch_loss = 6;
}

// 2. Individual image with JPEG data
message ImageData {
  bytes image_bytes = 1;  // JPEG-encoded image data
}

// 3. Prediction with confidence scores
message Prediction {
  int32 predicted_class = 1;  // Predicted class index
  float confidence = 2;       // Confidence score (0.0 - 1.0)
}

// 4. Per-epoch metrics data (LOW FREQUENCY ~1/epoch)
message EpochData {
  uint32 epoch = 1;
  float average_loss = 2;
  float average_accuracy = 3;
}
